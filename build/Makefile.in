# Once compiled run with
# for mpi:
# mpirun -np 1 ./staggamma --grid 4.4.4.4 
# for scalar:
# ./staggamma --grid 4.4.4.4 

# Grid installation path (configured by autoconf)
gridinstall=@GRID_PREFIX@
config=$(gridinstall)/bin/grid-config

# Compiler flags (configured by autoconf)
OPTFLAGS=@OPTFLAGS@
DEBUGFLAGS=@DEBUGFLAGS@
A2A_BLOCKING_FLAGS=@A2A_BLOCKING_FLAGS@

INCLUDES := -I../src/cpp/shared # Manually specify include dirs
#
#  flags from the grid utility program
#
CXXFLAGS= $(shell $(config) --cxxflags) -I$(gridinstall)/include $(OPTFLAGS) $(DEBUGFLAGS) $(A2A_BLOCKING_FLAGS)
LDFLAGS=$(shell $(config) --ldflags)
LIBS= $(shell $(config) --libs) -L$(gridinstall)/lib -lGrid
COMPILER=$(shell $(config) --cxx)

GPUFLAGS=
ifneq ($(DEBUGFLAGS),)
	GPUFLAGS= -lineinfo -lnvToolsExt
endif

original_stag_gamma: ../src/_original_Test_stag_gamma.cc
	$(COMPILER) $(INCLUDES) -o $@ $(CXXFLAGS) ../src/_original_Test_stag_gamma.cc $(LDFLAGS) $(LIBS) 

stag_gamma: ../src/Test_stag_gamma.cc
	$(COMPILER) $(INCLUDES) -o $@ $(CXXFLAGS) ../src/Test_stag_gamma.cc $(LDFLAGS) $(LIBS)

test_blas: ../src/Test_blas.cc
	$(COMPILER) $(INCLUDES) -o $@ $(GPUFLAGS) $(CXXFLAGS)  ../src/Test_blas.cc  $(LDFLAGS) $(LIBS) 

meson_field: ../src/Test_meson_field.cc
	$(COMPILER) $(INCLUDES) -o $@ $(GPUFLAGS) $(CXXFLAGS)  ../src/Test_meson_field.cc  $(LDFLAGS) $(LIBS) 

# meson_field.o: ../src/Test_meson_field.cc
# 	$(COMPILER) -O3 $(INCLUDES) -c -o $@ -g -lineinfo $(CXXFLAGS)  ../src/Test_meson_field.cc  $(LDFLAGS) $(LIBS) 
#
# Test_meson_field: 
# 	nvcc -O3 $(INCLUDES) -o Test_meson_field meson_field.o $(CXXFLAGS)  $(LDFLAGS) $(LIBS) 

grid_lmi: ../src/Grid_LMI.cc
	$(COMPILER) $(INCLUDES) -I../src/cpp/gridlmi -o $@ $(GPUFLAGS) $(CXXFLAGS)  ../src/Grid_LMI.cc ../src/cpp/gridlmi/IO.cc  $(LDFLAGS) $(LIBS)

clean:
	rm -f stag_gamma original_stag_gamma meson_field grid_lmi

.PHONY: clean 
